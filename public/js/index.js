import {makeFrequencySpectrum,} from './image-conversion.js';

window.onload = () => {
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const image = document.getElementById("source");
    ctx.drawImage(image, 0, 0);

    const frequencies = makeFrequencySpectrum(canvas);

    const audioCtx = new AudioContext();
    const synths = frequencies.map(() => audioCtx.createOscillator());
    const gains = synths.map(() => audioCtx.createGain());
    const masterGain = audioCtx.createGain();
    masterGain.gain.value = 1;
    
    // set oscillators to frequencies generated by image
    for (let i = 0; i < synths.length; i++) {
        synths[i].frequency.value = frequencies[i][0];
    }

    // set gains according to the luma of each pixel
    for (let i = 0; i < gains.length; i++) {
        gains[i].gain.value = frequencies[i][1] / frequencies.length;
    }

    // connect synths and gains together
    for (let i = 0; i < synths.length; i++) {
        synths[i].connect(gains[i]);
    }

    // route everything to the master gain control
    for (let i = 0; i < gains.length; i++) {
        gains[i].connect(masterGain);;
    }

    masterGain.connect(audioCtx.destination);

    const startButton = document.getElementById("click-me");
    startButton.addEventListener("click", () => {
        synths.forEach(synth => synth.start(0));
    })
}

